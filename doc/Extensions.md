扩展系统
=====================

为了实现将AI绘图的能力和其他各种新技术组合起来，扩展系统必不可少。
本扩展系统支持扩展：

1. 新的服务器端API - 扩展可以向服务器端添加新API
2. 新的可调用的包 - 扩展中的Python包将被自动添加到Path目录，执行时可以找到
3. 新的UI系统 - 对一个文件扩展，可以添加新的UI界面，并可以通过ssui_components和已有的UI进行整合


## 扩展系统的调用逻辑

首先，server在启动时会扫描 extensions 下的所有子目录（不递归扫描），将里面有 ssextension.yaml 的目录都列为一个扩展。
server/extensions.py 是扩展系统的加载逻辑

然后各个目录的yaml文件会被解析，我们来简要说明一下各个字段的含义：

```
name: ImageExtension    =>  插件的名称
version: 0.1.0          =>  版本信息
server:
  venv: shared          =>  使用哪个虚拟环境，默认为 shared 表示和其他插件放到同一个虚拟环境中，如果有其他自定义的名称，则另创建一个该名字的虚拟环境
  dependencies:
    - numpy>=1.21.2     =>  依赖的包，可以指定版本
  main: extension.py    =>  插件的入口文件，必须存在
  packages:
    - ssui_image        =>  插件注册的Python包，会被自动添加到Path目录，执行时可以找到

web_ui:
  dist: dist/           =>  插件的UI文件目录，用来部署js，css等静态文件
```


在读到 main: extension.py 时，会自动加载这个文件，并执行其中的代码。插件可以在 extension.py 中添加自己的API，也可以加载自己的Python包。
dist目录则会自动创建一个静态的文件目录，使得服务器能访问到js，css等静态文件。

## 扩展系统的依赖项目

如果你编写Python代码，很可能给扩展添加依赖，那么你可能会遇到以下问题。为了保障所有扩展都使用尽可能相同的依赖，在构建时，我们自定义的构建系统会处理依赖的安装。
简要来说，构建系统会扫描所有扩展的依赖和版本，加上主项目的依赖一起计算其相交子集，然后创建一个合并后的requirements.txt文件。

之后，一个lock文件会被创建，用来锁定依赖的版本。而最后部署时，每个插件都会生成一个独立的锁定了版本的requirements.txt文件，pip直接安装即可。
通过合并计算的方式，可以保证两个扩展依赖同一个库时，最终版本是锁定相同的。

## 创建新扩展

extension_builder 是我们的一个扩展构建工具，可以创建新的扩展。有如下几个指令：
1. new 指令，交互式创建一个新插件，并在当前文件夹下创建新目录和对应项目文件, 参考ssextension.yaml
2. init 指令，在当前文件夹下初始化项目，用文件夹名作为项目名
3. package 指令，检测当前是否有package.json, 若存在，则执行其中的package命令，然后将生成的js与当前插件的python文件、配置等打包成一个tar.gz

命令行使用方法：

```
ssext new <extension_name>
ssext init               # 在当前目录初始化一个扩展
ssext package            # 将当前扩展打包成tar.gz文件
```

如果想全局使用，可以link到系统中：
```
cd extension_builder
npm link
```

不想用时 unlink 删除即可。
注意：yarn link 好像有些不同，最好使用npm link

这个插件希望未来可以支持和我们的插件服务器进行交互，直接发布，测试插件。


## 扩展系统的升级

在同一个目标SSUI版本中，如果一个包的版本已经被锁定，哪怕有新插件发布，那么这个包的版本不会被升级。只有等下一个SSUI版本发布时，所有扩展的依赖都会被重新计算，然后升级。
这样做的目的是，我们为了保证所有包的版本都是兼容且通过测试的，避免安装后出现符号找不到等问题。

如果你必须使用新版本，那么有两者方式：
1. 手动将你要用的包改名，并作为源代码包引入
2. 使用venv创建一个新的派生虚拟环境，将通过安装新的包将原来环境中的进行替换，但这会造成潜在的不稳定可能，所以用户需要自行决定是否使用

## 扩展系统的测试

我们官方开发的插件，都会在构建环境下进行测试，确保其可以正常使用。
而其他插件作者需要自行编写测试用例，在发布时一并上传，在服务器测试环境进行测试。如果失败则会在平台上提示失败信息，请及时修复。



