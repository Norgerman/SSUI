Executor
=====================

ss_executor是Stable Scripts的执行器，负责执行用户脚本。我们不能在server中直接执行用户脚本，这出于以下几个考量：

1. 安全问题，脚本需要运行在安全的沙盒中，独立的进程能够进一步隔离潜在风险
2. 非阻塞设计，server需要同时处理多个请求，而独立的进程可以避免阻塞服务器的运行
3. 高可靠设计，一旦执行器崩溃，server或UI系统可以自动重启执行器，确保服务的可靠性
4. 分布式设计，执行器可以分布式部署，例如在多台机器上部署多个执行器，提高系统的吞吐量
5. 多venv支持，分离的执行器可以不同进程中支持不同torch或其他python库版本，对于插件开发者更加友好


## 执行器架构

执行器是一个独立的进程，它通过websocket协议和server通信。
websocket服务器端代码主要在`ss_executor/scheduler.py`文件中，这个模块会被server加载，创建一个websocket服务器，监听端口5000。

执行器启动代码则是`ss_executor/__main__.py`文件，这个模块会加载执行器的主函数，并自动连接到server。

## 执行器使用说明

### 1. 任务定义

执行器通过Task对象来定义和执行任务。一个Task包含以下主要属性：

- `task_id`: 任务的唯一标识符
- `script`: 要执行的脚本路径
- `callable`: 要执行的具体函数名
- `params`: 传递给函数的参数字典
- `details`: 任务的详细信息
- `use_sandbox`: 是否使用沙盒环境（默认True）
- `timeout`: 任务超时时间（默认300秒）
- `priority`: 任务优先级（默认0）


### 2. 执行器注册

执行器启动时会自动向服务器注册，需要提供以下信息：

- `executor_id`: 执行器唯一标识符
- `host`: 执行器主机地址
- `port`: 执行器端口
- `max_tasks`: 最大并发任务数（默认1）
- `capabilities`: 执行器支持的功能列表

### 3. 任务执行流程

1. 服务器创建Task对象并添加到任务队列
2. 调度器根据优先级和可用执行器分配任务
3. 执行器接收任务并在沙盒环境中执行
4. 执行完成后返回TaskResult，包含执行结果或错误信息

### 4. 状态管理

任务状态包括：
- PENDING: 等待执行
- RUNNING: 正在执行
- COMPLETED: 执行完成
- FAILED: 执行失败
- CANCELLED: 已取消

### 5. 错误处理

- 执行器崩溃会自动断开连接
- 任务执行超时会自动终止
- 执行失败会返回详细的错误信息
- 服务器可以自动重启执行器

### 6. 最佳实践

1. 合理设置任务优先级，确保重要任务优先执行
2. 使用沙盒环境执行不信任的脚本
3. 设置适当的超时时间，避免任务无限等待
4. 在分布式部署时，根据执行器能力合理分配任务
5. 定期检查执行器状态，确保系统稳定性


